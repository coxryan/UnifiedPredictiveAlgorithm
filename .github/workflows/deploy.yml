name: Deploy site

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  # Nightly refresh and deploy (UTC 04:10)
  schedule:
    - cron: "10 4 * * *"

permissions:
  contents: read
  pages: write
  id-token: write

env:
  # Model years
  UPA_YEAR: ${{ vars.UPA_YEAR || '2025' }}
  UPA_BACKTEST_YEAR: ${{ vars.UPA_BACKTEST_YEAR || '2024' }}

  # Market selection (cfbd or fanduel)
  MARKET_SOURCE: ${{ vars.MARKET_SOURCE || 'fanduel' }}

  # API keys
  CFBD_API_KEY: ${{ secrets.CFBD_API_KEY }}
  ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}

  # Cache folders
  CFBD_CACHE_DIR: .cache_cfbd
  ODDS_CACHE_DIR: .cache_odds
  ODDS_CACHE_TTL_DAYS: 2

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show requested market
        run: |
          echo "Requested MARKET_SOURCE=${MARKET_SOURCE}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Restore CFBD cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CFBD_CACHE_DIR }}
          key: cfbd-${{ env.UPA_YEAR }}-${{ env.MARKET_SOURCE }}

      - name: Restore Odds cache
        uses: actions/cache@v4
        with:
          path: ${{ env.ODDS_CACHE_DIR }}
          key: odds-${{ env.UPA_YEAR }}-${{ env.MARKET_SOURCE }}

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f agents/requirements.txt ]; then pip install -r agents/requirements.txt; fi

      - name: Run collector (live + backtest)
        env:
          BEARER_TOKEN: ${{ env.CFBD_API_KEY }}
        run: |
          set -euo pipefail
          echo "Starting collector for ${UPA_YEAR} (backtest ${UPA_BACKTEST_YEAR}) with market=${MARKET_SOURCE}"
          python agents/collect_cfbd_all.py \
            --year "${UPA_YEAR}" \
            --backtest "${UPA_BACKTEST_YEAR}" \
            --market "${MARKET_SOURCE}" \
            --data-dir "data" \
            --cache-cfbd "${CFBD_CACHE_DIR}" \
            --cache-odds "${ODDS_CACHE_DIR}" \
            --odds-api-key "${ODDS_API_KEY}" \
            --cfbd-api-key "${CFBD_API_KEY}" || true

          echo "Collector finished; status.json (if present):"
          if [ -f data/status.json ]; then cat data/status.json || true; fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (no lockfile required)
        run: |
          npm install --no-audit --no-fund

      - name: Build site
        run: |
          npm run build

      - name: Bundle data into site
        run: |
          mkdir -p dist/data
          if [ -d data ]; then cp -R data/* dist/data/ || true; fi

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4